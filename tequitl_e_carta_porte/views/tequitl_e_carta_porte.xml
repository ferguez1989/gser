<?xml version="1.0"?>
<odoo>
  <template id="tequitl_cfdiv33_cartaporte" inherit_id="l10n_mx_edi.cfdiv33">
    <xpath expr="//*[name()='cfdi:Concepto']" position="inside">
      <cfdi:InformacionAduanera xmlns:cfdi="http://www.sat.gob.mx/cfd/3"
        t-if="record.carta_porte_picking_id.l10n_mx_edi_is_export and record.carta_porte_picking_id.l10n_mx_edi_customs_no"
        t-att-NumeroPedimento="record.carta_porte_picking_id.l10n_mx_edi_customs_no"/>
    </xpath>
    <xpath expr="//*[name()='cfdi:Comprobante']" position="inside">
      <cfdi:Complemento
        xmlns:cfdi="http://www.sat.gob.mx/cfd/3">
        <cartaporte20:CartaPorte
          xmlns:cartaporte20="http://www.sat.gob.mx/CartaPorte20"
          t-if="record.carta_porte_picking_id"
          t-att-TranspInternac="'SÃ­' if record.carta_porte_picking_id.l10n_mx_edi_is_export else 'No'"
          t-att-TotalDistRec="record.carta_porte_picking_id.l10n_mx_edi_distance"
          t-att-EntradaSalidaMerc="'Salida' if record.carta_porte_picking_id.l10n_mx_edi_is_export else None"
          t-att-ViaEntradaSalida="record.carta_porte_picking_id.l10n_mx_edi_transport_type if record.carta_porte_picking_id.l10n_mx_edi_is_export else None"
          t-att-PaisOrigenDestino="record.carta_porte_picking_id.partner_id.country_id.l10n_mx_edi_code if record.carta_porte_picking_id.l10n_mx_edi_is_export else None"
          Version="2.0">
          <cartaporte20:Ubicaciones>
            <cartaporte20:Ubicacion TipoUbicacion="Origen"
              t-att-IDUbicacion="'OR' + str(record.carta_porte_picking_id.location_id.id).rjust(6,'0')"
              t-att-FechaHoraSalidaLlegada="cfdi_date" t-att-RFCRemitenteDestinatario="supplier.vat">
              <cartaporte20:Domicilio t-att-Calle="supplier.street"
                t-att-Colonia="supplier.l10n_mx_edi_colony_code"
                t-att-Municipio="supplier.partner_id.city_id.l10n_mx_edi_code"
                t-att-CodigoPostal="supplier.zip" t-att-Estado="supplier.state_id.code"
                t-att-Pais="supplier.country_id.l10n_mx_edi_code"/>
            </cartaporte20:Ubicacion>
            <cartaporte20:Ubicacion TipoUbicacion="Destino"
              t-att-IDUbicacion="'DE' + str(record.carta_porte_picking_id.location_dest_id.id).rjust(6,'0')"
              t-att-DistanciaRecorrida="record.carta_porte_picking_id.l10n_mx_edi_distance"
              t-att-FechaHoraSalidaLlegada="scheduled_date"
              t-att-RFCRemitenteDestinatario="customer.vat if not record.carta_porte_picking_id.l10n_mx_edi_is_export else 'XEXX010101000'"
              t-att-NumRegIdTrib="customer.vat if record.carta_porte_picking_id.l10n_mx_edi_is_export else None"
              t-att-ResidenciaFiscal="record.carta_porte_picking_id.partner_id.country_id.l10n_mx_edi_code if record.carta_porte_picking_id.l10n_mx_edi_is_export else None">
              <cartaporte20:Domicilio t-att-Calle="record.carta_porte_picking_id.partner_id.street"
                t-att-Colonia="record.partner_id.l10n_mx_edi_colony_code"
                t-att-Municipio="record.partner_id.city_id.l10n_mx_edi_code"
                t-att-CodigoPostal="record.carta_porte_picking_id.partner_id.zip"
                t-att-Estado="record.carta_porte_picking_id.partner_id.state_id.code"
                t-att-Pais="record.carta_porte_picking_id.partner_id.country_id.l10n_mx_edi_code"/>
            </cartaporte20:Ubicacion>
          </cartaporte20:Ubicaciones>
          <cartaporte20:Mercancias t-att-NumTotalMercancias="len(moves)"
            t-att-PesoBrutoTotal="format_float(sum(moves.mapped('weight')), 3)"
            t-att-UnidadPeso="weight_uom.unspsc_code_id.code">
            <t t-foreach="moves" t-as="move">
              <cartaporte20:Mercancia t-att-BienesTransp="move.product_id.unspsc_code_id.code"
                t-att-FraccionArancelaria="move.product_id.l10n_mx_edi_tariff_fraction_id.code if record.carta_porte_picking_id.l10n_mx_edi_is_export else None"
                t-att-Cantidad="format_float(move.quantity_done, 6)"
                t-att-ClaveUnidad="move.product_uom.unspsc_code_id.code"
                t-att-Descripcion="move.description_picking or move.product_id.name"
                t-att-PesoEnKg="format_float(move.weight, 3)">
                <cartaporte20:CantidadTransporta
                  t-att-Cantidad="format_float(move.quantity_done, 6)"
                  t-att-IDOrigen="'OR' + str(record.carta_porte_picking_id.location_id.id).rjust(6,'0')"
                  t-att-IDDestino="'DE' + str(record.carta_porte_picking_id.location_dest_id.id).rjust(6,'0')"/>
              </cartaporte20:Mercancia>
            </t>
            <cartaporte20:Autotransporte
              t-if="record.carta_porte_picking_id.l10n_mx_edi_transport_type == '01'"
              t-att-NumPermisoSCT="record.carta_porte_picking_id.l10n_mx_edi_vehicle_id.name"
              t-att-PermSCT="record.carta_porte_picking_id.l10n_mx_edi_vehicle_id.transport_perm_sct">
              <cartaporte20:IdentificacionVehicular
                t-att-AnioModeloVM="record.carta_porte_picking_id.l10n_mx_edi_vehicle_id.vehicle_model"
                t-att-ConfigVehicular="record.carta_porte_picking_id.l10n_mx_edi_vehicle_id.vehicle_config"
                t-att-PlacaVM="record.carta_porte_picking_id.l10n_mx_edi_vehicle_id.vehicle_licence"/>
              <cartaporte20:Seguros
                t-att-AseguraRespCivil="record.carta_porte_picking_id.l10n_mx_edi_vehicle_id.transport_insurer"
                t-att-PolizaRespCivil="record.carta_porte_picking_id.l10n_mx_edi_vehicle_id.transport_insurance_policy"/>
              <cartaporte20:Remolques
                t-if="record.carta_porte_picking_id.l10n_mx_edi_vehicle_id.trailer_ids">
                <t t-foreach="record.carta_porte_picking_id.l10n_mx_edi_vehicle_id.trailer_ids"
                  t-as="trailer">
                  <cartaporte20:Remolque t-att-SubTipoRem="trailer.sub_type"
                    t-att-Placa="trailer.name"/>
                </t>
              </cartaporte20:Remolques>
            </cartaporte20:Autotransporte>
          </cartaporte20:Mercancias>
          <cartaporte20:FiguraTransporte>
            <t
              t-foreach="record.carta_porte_picking_id.l10n_mx_edi_vehicle_id.figure_ids.sorted(lambda f: f.type)"
              t-as="figure">
              <cartaporte20:TiposFigura t-att-TipoFigura="figure.type"
                t-att-RFCFigura="figure.operator_id.vat"
                t-att-NumLicencia="figure.type == '01' and figure.operator_id.l10n_mx_edi_operator_licence">
                <t t-foreach="figure.part_ids" t-as="part">
                  <cartaporte20:PartesTransporte t-if="figure.type in ('02', '03')"
                    t-att-ParteTransporte="part.code"/>
                </t>
              </cartaporte20:TiposFigura>
            </t>
          </cartaporte20:FiguraTransporte>
        </cartaporte20:CartaPorte>
      </cfdi:Complemento>
    </xpath>
  </template>
</odoo>
